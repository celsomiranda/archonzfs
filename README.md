# archonzfs
Install Arch on ZFS.

Uses eoli3n archiso-zfs script to load zfs modules into ISO.

Then installs arch with root on zfs. It currently only uses a single single vdev and I don't have the desire yet to add more options.

For installation it creates a dataset structure of:

zroot -- encrypted; root dataset is encrypted
zroot/ROOT/ -- encrypted; location for root filesystem for the system. This is where ZFSBootMenu will look for Boot Environments
zroot/data/home/$USERNAME -- encrypted; use the usercreate following install to create encrypted home users
zroot/var/ -- encrypted; Libvirt and LXD mountable datasets

There is no unecrypted dataset. Modify zpool creation if this is required

Configures pam_zfs_key.so for system-login and su-l. This means that su-l will require pressing Return while as root to continue su-l into that user. This is due to pam_zfs_key opening a password conversation as part of the session. If you remove su-l configuration then pam_zfs_key it will not unlock. You can work around this by setting auth sufficient pam_rootok.so instead. See https://github.com/openzfs/zfs/issues/11222#issuecomment-1033379044

Uses UKI generated by mkinitcpio for booting with systemd-boot for easy sourcing of UKIs.
Use Clevis to decrypt a secret within initramfs for unattended reboots for UKIs. Secret is encrypted with TPM2 and provides key to decrypt root dataset.
Additionally uses ZFSBootMenu for access to a Kernel Command Line when using Secureboot. Additionally has option of configuring with remote access unlock via dropbear (On port 2222 and public-key auth)

Options:
ZFSBootMenu remote decryption with Dropbear in initramfs
Encrypted Swap Space.
If not used, recommend using ZRAM (not configured).
Resume Support with Clevis to decrypt the Luks2 encrypted Swap Space

Optional:
Have the box act like a Steam Console with steam.sh. Installs steam (amd-drivers) and sets up autologin for the steamuser. Uses Xorg (openbox) since cage seems to have issues with the new steam bigpicture.
Create Encrypted Home Directories for users. This is done post-install
